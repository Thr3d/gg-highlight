#!/bin/bash 
# Filename: gg
# Description: Log filtering and highlighting
# jesse.chandler@suse.com
# Supportconfig/hb_report log filter & highlighter
# Usage: gg [options] [file]
# GREP_COLORS="$COLOR" $grepsearch|$grepfilter -f </var/lib/gg-highlight/file containing patterns. e.g. '^.*.*$|$'>

##TODO remove binary chars on the fly (Nasty bits added when syslog starts sometimes).
#This is the manual way to clean those up.
#cat messages|tr -cd '\11\12\15\40-\176' > messages.new && mv -f messages.new messages
##TODO add bash completion

VERSION=1.3.0

# Coloring
RED='mt=1;37;41'
YELLOW='mt=01;33'
GREEN='mt=01;32'
WHITERED='mt=47;1;31'
PURPLE='mt=01;1;35'
# Commands
grepsearch='grep -E --text --color=always --line-buffered'
grepfilter='grep --text --line-buffered -Ev'
# Lists/Arrays
redpatterns=("general-red" "ha-red" "sap-red" "hacib-red" "drbd-red" "trento-red")
yellowpatterns=("general-yellow" "ha-yellow" "sap-yellow" "supportconfig-yellow" "hacib-yellow" "drbd-yellow")
greenpatterns=("general-green" "ha-green" "hacib-green" "corosynclog-green" "sap-green" "drbd-green")
whitepatterns=("rpm-white")
purplepatterns=("ha-status-purple")
filters=("filter-general" "filter-ha" "filter-sap")
experimental=("filter-test" "filter-disk" "filter-systemd")
products=("ha" "sap" "trento")
# Default Booleans
FILTER=false
EXPERIMENTAL=false

function usage() {
	echo "Usage: gg [OPTION]... [FILE]"
	echo "-i, --ignore, -f, --filter 			Enable filtering"
	echo "-v, --version 					Display version"
	echo "-h, --help 					Show this list"
	echo "-d, --disable ["${products[@]}"]			disable product filter"
	echo "-e, --experimental				enable experimental features"
}

function display_version() {
	echo "gg-highlight version $VERSION"
}

function reduce-arrays() {
        for i in "${!redpatterns[@]}"
        do
                if [[ "${redpatterns[$i]}" = "$1"* ]]
                then
                        unset "redpatterns[$i]"
                fi
        done
        for i in "${!yellowpatterns[@]}"
        do
                if [[ "${yellowpatterns[$i]}" = "$1"* ]]
                then
                        unset "yellowpatterns[$i]"
                fi
        done
        for i in "${!greenpatterns[@]}"
        do
                if [[ "${greenpatterns[$i]}" = "$1"* ]]
                then
                        unset "greenpatterns[$i]"
                fi
        done
        for i in "${!whitepatterns[@]}"
        do
                if [[ "${whitepatterns[$i]}" = "$1"* ]]
                then
                        unset "whitepatterns[$i]"
                fi
        done
        for i in "${!filters[@]}"
        do
                if [[ "${filters[$i]}" = *"$1" ]]
                then
                        unset "filters[$i]"
                fi
        done
}

if [ "$1" != "" ]; then
        while true; do
                case "$1" in
                        -h | --help )
                                usage
                                exit 1
                                ;;
                        -v | --version )
                                display_version
                                exit 1
                                ;;
                        -i | --ignore | -f | --filter )
                                FILTER=true
                                shift
                                ;;
                        -d | --disable )
				MATCH=false
				for product in "${products[@]}"
				do
					if [[ "$product" = "$2" ]]; then
						MATCH=true
						break
					fi
				done
				if [[ $MATCH = true ]]; then
                                	reduce-arrays $2
                                else
                                        echo "-d/--disable must have a valid product name. ["${products[@]}"]"
                                        exit 1
                                fi
                                shift 2
                                ;;
                        -e | --experimental )
                                EXPERIMENTAL=true
                                shift
                                ;;
                        -- )
                                shift
                                break
                                ;;
                        * )
                                break
                                ;;
                esac
        done
fi

# Check for arguments
if [ $# -eq 0 ]; then
    if [ ! -t 0 ]; then
        cat >.tmp
        tmp=".tmp"
        set -- "$tmp" "${@:2}"
    else
        echo "No arguments provided"
        exit 1
    fi
fi

# Check if last argument is file
file_arg=$(echo "${@: -1}")
if [[ ! -e $file_arg ]]; then
	echo "$file_arg is not a file. Aborting."
	exit 1
fi

# Don't include hacib stuff unless "cib" is in the name of the file
if  ! echo "$file_arg" | grep -E "cib*|ha.txt|pe-input-*|pe-warn-*|pe-error-*|plugin-ha_sap.txt|corosync.conf|configure_show.txt"; then
        reduce-arrays "hacib"
fi

function iterate-redhighlights() {
	greplist=()
	for i in "${redpatterns[@]}"
	do
		greplist+=( -f /var/lib/gg-highlight/"${i}".txt)
	done
	LANG=C LC_ALL=C GREP_COLORS="$RED" $grepsearch "${greplist[@]}"
}

function iterate-yellowhighlights() {
	greplist=()
	for i in "${yellowpatterns[@]}"
	do
		greplist+=( -f /var/lib/gg-highlight/"${i}".txt)
	done
	LANG=C LC_ALL=C GREP_COLORS="$YELLOW" $grepsearch "${greplist[@]}"
}

function iterate-greenhighlights() {
	greplist=()
	for i in "${greenpatterns[@]}"
	do
		greplist+=( -f /var/lib/gg-highlight/"${i}".txt)
	done
	LANG=C LC_ALL=C GREP_COLORS="$GREEN" $grepsearch "${greplist[@]}"
}

function iterate-whitehighlights() {
        greplist=()
        for i in "${whitepatterns[@]}"
        do
                greplist+=( -f /var/lib/gg-highlight/"${i}".txt)
        done
        LANG=C LC_ALL=C GREP_COLORS="$WHITERED" $grepsearch "${greplist[@]}"
}

function iterate-purplehighlights() {
        greplist=()
        for i in "${purplepatterns[@]}"
        do
                greplist+=( -f /var/lib/gg-highlight/"${i}".txt)
        done
        LANG=C LC_ALL=C GREP_COLORS="$PURPLE" $grepsearch "${greplist[@]}"
}



function iterate-filters() {
	if [[ $FILTER = true ]]; then
		greplist=()
		for i in "${filters[@]}"
		do
			greplist+=(-f /var/lib/gg-highlight/"$i".txt)
		done
		LANG=C LC_ALL=C $grepfilter "${greplist[@]}" --
	else
		cat
	fi
}

function iterate-experimental() {
	if [[ $EXPERIMENTAL = true ]]; then
		greplist=()
		for i in "${experimental[@]}"
		do
			greplist+=(-f /var/lib/gg-highlight/"$i".txt)
		done
		LANG=C LC_ALL=C $grepfilter "${greplist[@]}" --
	else
		cat
	fi
}

function allyourlogsarebelongtome() {
	iterate-filters |\
	iterate-experimental |\
	iterate-purplehighlights |\
	iterate-redhighlights |\
	iterate-yellowhighlights |\
	iterate-greenhighlights |\
	iterate-whitehighlights 
}

cat "$file_arg" | allyourlogsarebelongtome | less
