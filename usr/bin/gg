#!/bin/bash
# jesse.chandler@suse.com
# Version: 1.0.0
# Supportconfig/hb_report log filter & highlighter
# Usage: gg [file]
# GREP_COLOR="$COLOR" $search '^.*.*$|$' |\

##TODO remove binary chars on the fly
#cat messages|tr -cd '\11\12\15\40-\176' > messages.new && mv -f messages.new messages

RED='1;37;41'
YELLOW='01;33'
GREEN='01;32'
search='egrep --text --color=always --line-buffered'

cat $1 |\
# IGNORE
grep --text -Ev 'su: \(to|/usr/sbin/cron\[|syslog-ng.*Log statistics|SAPHana\(|SAPHanaTopology\(|smartd.*failed to read Temperature|systemd-logind.* New session .* of user|su: pam_unix.* session opened for user|su: pam_unix.* session closed for user|sshd.* pam_unix\(sshd:session\): session opened for user|sshd.* pam_unix\(sshd:session\): session closed for user|CRON.* pam_unix\(crond:session\): session opened for user|CRON.* pam_unix\(crond:session\): session closed for user|cron.* pam_unix\(crond:session\): session opened for user|cron.* pam_unix\(crond:session\): session closed for user|CRON.* \(root\) CMD \(\[ -x /usr/lib64/sa/sa1 \] && exec /usr/lib64/sa/sa1 -S ALL 1 1\)|systemd\[1\]: Starting Session|systemd\[1\]: Started Session|systemd-logind.*: Removed session|sshd.*: Received disconnect from|sshd.*: Accepted publickey for|adclient.* INFO|adcert.* WARN|rhnsd.* running program /usr/sbin/rhn_check|systemd.*: Reached target Sockets.|systemd.*|systemd.*: Reached target Timers.|systemd.*: Reached target Paths.|systemd.*: Reached target Basic System.|systemd.*: Reached target Default.|systemd.*: Startup finished in .*.|systemd.*: Started User Manager for UID .*.|systemd.*: Stopping User Manager for UID .*...|systemd.*: Stopped target Default.|systemd.*: Stopped target Basic System.|systemd.*: Stopped target Paths.|systemd.*: Reached target Shutdown.|systemd.*: Stopped target Sockets.|systemd.*: Stopped target Timers.|systemd.*: Starting Exit the Session...|systemd.*: Received SIGRTMIN+24 from PID .* (kill).|systemd: pam_unix(systemd-user:session): session closed for user .*|systemd.*: Stopped User Manager for UID .*.|systemd.*: Removed slice User Slice of .*.|systemd.*: Created slice User Slice of .*.|systemd.*: Starting User Manager for UID .*...|systemd: pam_unix(systemd-user:session): session opened for user .* by |systemd.*: Reached target Paths.|sshd.*: Disconnected|CRON\[.*\]:|sshd.*: Failed password|sshd.*: Accepted password|crontab\[.*\]:|puppet-agent\[.*\]: Applied catalog in|sshd.*: Connection closed by|sshd.*: Did not receive identification string from|sshd.*: Connection reset by|sudo: |sshd.* pam_winbind.* granted access|SAPRP1_00|cron.*: \(root\) CMD \(\[ -x /usr/lib64/sa/sa1 \] \&\& exec /usr/lib64/sa/sa1 -S ALL 1 1\)|sudo.*pam_vas:|sshd.*pam_lastlog|sshd.*Accepted keyboard-interactive|end_request: I/O error, dev fd0, sector 0|blk_update_request: I/O error, dev fd0, sector 0|puppet-agent\[.*| splunk\[.*|cron\[.*No such file or directory|sshd.*error: PAM: Authentication failure for|sshd.*pam_unix(sshd:auth): authentication failure|floppy: error -5 while reading block 0|snowagent:|sftp-server\[|sshd.* subsystem request for sftp|SAPFPA_00|packagekitd|su\[.*\]: |crmd.* notice: Processing graph|crmd.* notice: Transition.*Complete$|crmd.*notice: State transition S_TRANSITION_ENGINE -> S_IDLE|crmd.*notice: State transition S_IDLE -> S_POLICY_ENGINE|pengine\[.*:   notice: Relying on watchdog integration for fencing|pengine\[.*:   notice: On loss of CCM Quorum: Ignore|pengine\[.*:   notice: Calculated Transition.*.bz2$|HDB\[|HDB_SYSTEMDB\[|corosync.*\[IPC|corosync.*\[pcmk|corosync.*\[CPG|crmd\[.* notice: do_state_transition: State transition S_IDLE -> S_POLICY_ENGINE|pengine\[.* notice: unpack_config: On loss of CCM Quorum: Ignore|crmd\[.* notice: do_te_invoke: Processing graph|crmd\[.* notice: run_graph: Transition|pengine\[.*notice: process_pe_message: Calculated Transition|crm_attribute\[.*notice: crm_log_args: Invoked:|crmd\[.* notice: do_state_transition: State transition S_TRANSITION_ENGINE -> S_IDLE|attrd_updater\[.*notice: crm_log_args: Invoked: attrd_updater|auditd\[.*Audit daemon rotating log files|su: FAILED SU|stonith-ng\[.*notice: unpack_config: On loss of CCM Quorum: Ignore|xinetd|useradd\[|rtkit-daemon\[|dbus\[.* Successfully activated service .org.freedesktop.RealtimeKit1.|dbus\[.* Successfully activated service .org.freedesktop.hostname1.|dbus\[.* Successfully activated service .org.freedesktop.timedate1|sshd\[.* Invalid user .* from |sshd\[.* input_userauth_request: invalid user|sshd\[.* Postponed keyboard-interactive for invalid user .* from .* port |userdel\[|PackageKit: daemon|dbus\[.* activated service .org.freedesktop.PackageKit.|PackageKit:|puma\[|audit_printk_skb: .* callbacks suppressed|audit\(.*|hpfiordo:|automount\[|cimserver\[| ifup-dhcp:| ifdown: | ifup: |SuSEfirewall2: SuSEfirewall2 not active|no IPv6 routers present|IIB\[|sshd\[.* Failed keyboard-interactive/pam for invalid user|sntp\[|sshd\[.* Starting session|sshd\[.* Set /proc/self/oom_score_adj to 0|sshd\[.* Connection from|sshd\[.* Postponed publickey for|sshd\[.* Postponed keyboard-interactive for|sshd\[.* User child is on|sshd\[.* Postponed keyboard-interactive|vsftpd:|sshd\[.* Transfered:|sshd\[.* Closing connection|-- MARK --|collectd\[|rsyslogd-3000:|dhcpcd\[|dd.forwarder\[|dd.collector\[|dd.dogstatsd\[|sshd\[.*: error: PAM: User not known to the underlying authentication module for|Undeclared promise body|logger: INFO|kernel: .* usb .*: USB disconnect|kernel: .* usb .*: new low-speed USB|kernel: .* usb .*: New USB device found|kernel: .* usb .*: New USB device strings|kernel: .* usb .*: Product:|kernel: .* usb .*: Manufacturer|kernel: .* input: |kernel: .* generic-usb |info: Watchdog enabled.|collectd\[.*\]: Filter subsystem:|syslog-ng\[.*\]: Connection failed\; error=.Connection refused.|SYSTEMCHECK: |lrmd.*:   notice: executing - rsc:rsc_|lrmd.*:   notice: finished - rsc:rsc_|crmd.*:   notice: Result of notify operation for rsc_|crmd.*:|fsaua\[|fscachesize: |cryptctl\[.*: |kernel: \[    .........' |\
# RED'
# $RED $search '^.*.*$|$' |\

# General
GREP_COLOR="$RED" $search '(^.*syslog-ng starting up.*$|$|^.*x-info="http://www.rsyslog.com"\] start.*$|$|^.*x-info="http://www.rsyslog.com"\] exiting on signal 15..*$|$|^.*A processor.*$|$|^.*CLM CONFIGURATION CHANGE.*$|$|^.*warning: update_failcount:.*$|$|^.*multipathd:.*mark as failed.*$|$|^.*I/O error.*$|$|^.*rejecting I/O.*$|$|^.*multipathd:.* - tur checker reports path is down.*$|$|^.*device-mapper: multipath: Failing path.*$|$|^.*taints kernel.*$|$|^.*kernel taint.*$|$|^.*tainting kernel.*$|$|^.*BUG:.*$|$|^.*Oops:.*$|$|^.*syslogd.*restart.*$|$|^.*klogd.*started.*$|$|^.*Detected aborted journal.*$|$|^.*error: remounting filesystem read-only.*$|$|^.*segfault.*$|$|^.*syslog-ng.*: Termination requested via signal, terminating.*$|$|^.*syslog-ng.*: syslog-ng shutting down; version=.*$|$|^.*init: Entering runlevel:.*$|$|^.*init: Switching to runlevel:.*$|$|^.*shutdown.*: shutting down for system reboot.*$|$|^.*Link Down Event.*$|$|^.*IO failure.*$|$|^.*Readonly filesystem.*$|$|^.*Aborting journal.*$|$|^.*Detected IO errors while flushing file data on.*$|$|^.*pengine.*:    error:.*$|$|^.*XFS.*: Log I/O Error Detected.  Shutting down filesystem.*$|$|^.*fatal.*$|$|^.*kernel.* sd .* FAILED Result.*$|$|^.*kernel.* sd .* killing request.*$|$|^.*stonith-ng.* wants to fence.*$|$|^.*Writing reset to node.*$|$|^.*reset successfully delivered to.*$|$|^.*OutOfMemoryError.*$|$|^.*sbd.* WARN:.*$|$|^.*sbd.* ERROR:.*$|$|^.*NT_STATUS_ACCESS_DENIED.*$|$|^.*Scheduling Node .* for shutdown$|$|^.*quorum lost.*$|$|^.*out of memory.*$|$|^.*NO_MEMORY.*$|$|^.*No free memory.*$|$|^.*warning: Could not verify cluster configuration file /var/lib/pacemaker/cib/cib.xml: No such file or directory.*$|$|^.*Cancelling IO request due to timeout.*$|$|^.*sysrq: SysRq : sysrq: Trigger a crash.*$|$|^.*BTRFS info \(device .*\): forced readonly.*$|$|^.*lost page write due to IO error.*$|$|^.*BTRFS error.*$|$|^.*oom-killer.*$|$|^.*Executing suicide fencing.*$|$|^.*Requesting peer fencing.*$|$|^.*Our peer on the DC .* is dead.*$|$|^.*crit:.*$|$|^.*FAILED.*$|$)'|\
# SAP
GREP_COLOR="$RED" $search '(^.*Promote .* to be primary.*$|$|^.*PreferSiteTakeover selected so decrease promotion score here.*$|$)' |\

# YELLOW
# $YELLOW $search '^.*.*$|$' |\
GREP_COLOR="$YELLOW" $search '(^.*warning:.*$|$|^.*device-mapper: .*error.*$|$|^.*failed.*$|$|^.*mcelog:.*$|$|^.*recoverable transport error.*$|$|^.*xfs_log_force: error.*$|$|^.*tur checker timed out.*$|$|^.*Bad protocol version.*$|$|^.*Protocol major versions differ.*$|$|^.*blocked FC remote port time out.*$|$|^.*corosync.*Incrementing problem counter.*$|$|^.*Delaying fencing operations until there are resources to manage.*$|$|^.*state is now lost.*$|$|^.*unhandled error.*$|$|^.*kernel.* reservation conflict.*$|$|^.*info: We don.t have a DC right now..*$|$|^.*sbd_stonith can fence.*$|$|^.*notice: Removing.*from the membership list.*$|$|^.*Quorum lost.*$|$|^.*S_ELECTION.*$|$|^.*Executing reboot fencing operation .* on.*$|$|^.*I_NOT_DC.*$|$|^.*I_ELECTION_DC.*$|$|^.*WARNING:.*$|$|^.*ERROR:.*$|$|^.*Couldn.t find device with.*$|$|^.*Error.*$|$|^.*BTRFS warning.*$|$|^.*smartd.*: .* SMART Usage Attribute.*$|$)' |\

# GREEN
GREP_COLOR="$GREEN" $search '(^.*tur checker reports path is up.*$|$|^.*multipathd.*reinstated.*$|$|^.*corosync.*Decrementing problem counter.*$|$|^.*state is now member.*$|$|^.*Completed service synchronization, ready to provide service.*$|$|^.*quorum acquired.*$|$|^.*is now: member.*$|$|^.*info: Node state: online.*$|$|^.*info: Pacemaker health check: OK.*$|$|^.*notice: Quorum acquired.*$|$|^.*A new membership .* was formed..*$|$|^.*SuSEfirewall2 not active.*$|$|^.*Servant starting for device.*$|$)' |\

# Supportconfig Junk
GREP_COLOR="$YELLOW" $search '^.*===========================.*$|$' |\
less