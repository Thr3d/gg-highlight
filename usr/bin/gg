#!/bin/bash
# jesse.chandler@suse.com
# Version: 1.0.1
# Supportconfig/hb_report log filter & highlighter
# Usage: gg [file]
# GREP_COLOR="$COLOR" $search '^.*.*$|$' |\

##TODO remove binary chars on the fly
#cat messages|tr -cd '\11\12\15\40-\176' > messages.new && mv -f messages.new messages

RED='1;37;41'
YELLOW='01;33'
GREEN='01;32'
search='egrep --text --color=always --line-buffered'

cat $1 |\
# IGNORE
grep --text -Ev -- "\
-- MARK --|\
/usr/sbin/cron\[|\
adcert.* WARN|\
adclient.* INFO|\
attrd_updater\[.*notice: crm_log_args: Invoked: attrd_updater|\
audit\(.*|\
audit_printk_skb: .* callbacks suppressed|\
auditd\[.*Audit daemon rotating log files|\
automount\[|\
blk_update_request: I/O error, dev fd0, sector 0|\
cimserver\[|\
collectd\[.*\]: Filter subsystem:|\
collectd\[|\
corosync.*\[CPG|\
corosync.*\[IPC|\
corosync.*\[pcmk|\
crm_attribute\[.*notice: crm_log_args: Invoked:|\
crmd.* notice: Processing graph|\
crmd.* notice: Transition.*Complete$|\
crmd.*:   notice: Result of notify operation for rsc_|\
crmd.*:|\
crmd.*notice: State transition S_IDLE -> S_POLICY_ENGINE|\
crmd.*notice: State transition S_TRANSITION_ENGINE -> S_IDLE|\
crmd\[.* notice: do_state_transition: State transition S_IDLE -> S_POLICY_ENGINE|\
crmd\[.* notice: do_state_transition: State transition S_TRANSITION_ENGINE -> S_IDLE|\
crmd\[.* notice: do_te_invoke: Processing graph|\
crmd\[.* notice: run_graph: Transition|\
CRON.* \(root\) CMD \(\[ -x /usr/lib64/sa/sa1 \] && exec /usr/lib64/sa/sa1 -S ALL 1 1\)|\
CRON.* pam_unix\(crond:session\): session closed for user|\
cron.* pam_unix\(crond:session\): session closed for user|\
CRON.* pam_unix\(crond:session\): session opened for user|\
cron.* pam_unix\(crond:session\): session opened for user|\
cron.*: \(root\) CMD \(\[ -x /usr/lib64/sa/sa1 \] \&\& exec /usr/lib64/sa/sa1 -S ALL 1 1\)|\
CRON\[.*\]:|\
cron\[.*No such file or directory|\
crontab\[.*\]:|\
cryptctl\[.*: |\
dbus\[.* activated service .org.freedesktop.PackageKit.|\
dbus\[.* Successfully activated service .org.freedesktop.hostname1.|\
dbus\[.* Successfully activated service .org.freedesktop.RealtimeKit1.|\
dbus\[.* Successfully activated service .org.freedesktop.timedate1|\
dd.collector\[|\
dd.dogstatsd\[|\
dd.forwarder\[|\
dhcpcd\[|\
end_request: I/O error, dev fd0, sector 0|\
floppy: error -5 while reading block 0|\
fsaua\[|\
fscachesize: |\
HDB\[|\
HDB_SYSTEMDB\[|\
hpfiordo:|\
ifdown: |\
ifup-dhcp:|\
ifup: |\
IIB\[|\
info: Watchdog enabled.|\
kernel: .* generic-usb |\
kernel: .* input: |\
kernel: .* usb .*: Manufacturer|\
kernel: .* usb .*: new low-speed USB|\
kernel: .* usb .*: New USB device found|\
kernel: .* usb .*: New USB device strings|\
kernel: .* usb .*: Product:|\
kernel: .* usb .*: USB disconnect|\
kernel: \[    ......... |\
logger: INFO|\
lrmd.*:   notice: executing - rsc:rsc_|\
lrmd.*:   notice: finished - rsc:rsc_|\
no IPv6 routers present|\
PackageKit: daemon|\
PackageKit:|\
packagekitd|\
pengine\[.* notice: unpack_config: On loss of CCM Quorum: Ignore|\
pengine\[.*:   notice: Calculated Transition.*.bz2$|\
pengine\[.*:   notice: On loss of CCM Quorum: Ignore|\
pengine\[.*:   notice: Relying on watchdog integration for fencing|\
pengine\[.*notice: process_pe_message: Calculated Transition|\
puma\[|\
puppet-agent\[.*\]: Applied catalog in|\
puppet-agent\[.*|\
rhnsd.* running program /usr/sbin/rhn_check|\
rsyslogd-3000:|\
rtkit-daemon\[|\
SAPFPA_00|\
SAPHana\(|\
SAPHanaTopology\(|\
SAPRP1_00|\
sftp-server\[|\
smartd.*failed to read Temperature|\
snowagent:|\
sntp\[|\
splunk\[.*|\
sshd.* pam_unix\(sshd:session\): session closed for user|\
sshd.* pam_unix\(sshd:session\): session opened for user|\
sshd.* pam_winbind.* granted access|\
sshd.* subsystem request for sftp|\
sshd.*: Accepted password|\
sshd.*: Accepted publickey for|\
sshd.*: Connection closed by|\
sshd.*: Connection reset by|\
sshd.*: Did not receive identification string from|\
sshd.*: Disconnected|\
sshd.*: Failed password|\
sshd.*: Received disconnect from|\
sshd.*Accepted keyboard-interactive|\
sshd.*error: PAM: Authentication failure for|\
sshd.*pam_lastlog|\
sshd.*pam_unix\(sshd:auth\): authentication failure|\
sshd\[.* Closing connection|\
sshd\[.* Connection from|\
sshd\[.* Failed keyboard-interactive/pam for invalid user|\
sshd\[.* input_userauth_request: invalid user|\
sshd\[.* Invalid user .* from |\
sshd\[.* Postponed keyboard-interactive for invalid user .* from .* port |\
sshd\[.* Postponed keyboard-interactive for|\
sshd\[.* Postponed keyboard-interactive|\
sshd\[.* Postponed publickey for|\
sshd\[.* Set /proc/self/oom_score_adj to 0|\
sshd\[.* Starting session|\
sshd\[.* Transfered:|\
sshd\[.* User child is on|\
sshd\[.*: error: PAM: User not known to the underlying authentication module for|\
stonith-ng\[.*notice: unpack_config: On loss of CCM Quorum: Ignore|\
su: \(to|\
su: FAILED SU|\
su: pam_unix.* session closed for user|\
su: pam_unix.* session opened for user|\
su\[.*\]: |\
sudo.*pam_vas:|\
sudo: |\
SuSEfirewall2: SuSEfirewall2 not active|\
syslog-ng.*Log statistics|\
syslog-ng\[.*\]: Connection failed\; error=.Connection refused.|\
SYSTEMCHECK: |\
systemd-logind.* New session .* of user|\
systemd-logind.*: Removed session|\
systemd.*: Created slice User Slice of .*.|\
systemd.*: Reached target Basic System.|\
systemd.*: Reached target Default.|\
systemd.*: Reached target Paths.|\
systemd.*: Reached target Paths.|\
systemd.*: Reached target Shutdown.|\
systemd.*: Reached target Sockets.|\
systemd.*: Reached target Timers.|\
systemd.*: Received SIGRTMIN+24 from PID .* \(kill\).|\
systemd.*: Removed slice User Slice of .*.|\
systemd.*: Started User Manager for UID .*.|\
systemd.*: Starting Exit the Session...|\
systemd.*: Starting User Manager for UID .*...|\
systemd.*: Startup finished in .*.|\
systemd.*: Stopped target Basic System.|\
systemd.*: Stopped target Default.|\
systemd.*: Stopped target Paths.|\
systemd.*: Stopped target Sockets.|\
systemd.*: Stopped target Timers.|\
systemd.*: Stopped User Manager for UID .*.|\
systemd.*: Stopping User Manager for UID .*...|\
systemd: pam_unix\(systemd-user:session\): session closed for user .*|\
systemd: pam_unix\(systemd-user:session\): session opened for user .*|\
systemd\[1\]: Started Session|\
systemd\[1\]: Starting Session|\
Undeclared promise body|\
useradd\[|\
userdel\[|\
vsftpd:|\
xinetd\
"|\

# RED'
# $RED $search '^.*.*$|$' |\

# General
GREP_COLOR="$RED" $search "(\
^.*A processor.*$|$|\
^.*Aborting journal.*$|$|\
^.*BTRFS error.*$|$|\
^.*BTRFS info \(device .*\): forced readonly.*$|$|\
^.*BUG:.*$|$|\
^.*Cancelling IO request due to timeout.*$|$|\
^.*CLM CONFIGURATION CHANGE.*$|$|\
^.*crit:.*$|$|\
^.*Detected aborted journal.*$|$|\
^.*Detected IO errors while flushing file data on.*$|$|\
^.*device-mapper: multipath: Failing path.*$|$|\
^.*error: remounting filesystem read-only.*$|$|\
^.*Executing suicide fencing.*$|$|\
^.*FAILED.*$|$|\
^.*fatal.*$|$|\
^.*I/O error.*$|$|\
^.*init: Entering runlevel:.*$|$|\
^.*init: Switching to runlevel:.*$|$|\
^.*IO failure.*$|$|\
^.*kernel taint.*$|$|\
^.*kernel.* sd .* FAILED Result.*$|$|\
^.*kernel.* sd .* killing request.*$|$|\
^.*klogd.*started.*$|$|\
^.*Link Down Event.*$|$|\
^.*lost page write due to IO error.*$|$|\
^.*multipathd:.* - tur checker reports path is down.*$|$|\
^.*multipathd:.*mark as failed.*$|$|\
^.*No free memory.*$|$|\
^.*NO_MEMORY.*$|$|\
^.*NT_STATUS_ACCESS_DENIED.*$|$|\
^.*oom-killer.*$|$|\
^.*Oops:.*$|$|\
^.*Our peer on the DC .* is dead.*$|$|\
^.*out of memory.*$|$|\
^.*OutOfMemoryError.*$|$|\
^.*pengine.*:    error:.*$|$|\
^.*quorum lost.*$|$|\
^.*Readonly filesystem.*$|$|\
^.*rejecting I/O.*$|$|\
^.*Requesting peer fencing.*$|$|\
^.*reset successfully delivered to.*$|$|\
^.*sbd.* ERROR:.*$|$|\
^.*sbd.* WARN:.*$|$|\
^.*Scheduling Node .* for shutdown$|$|\
^.*segfault.*$|$|\
^.*shutdown.*: shutting down for system reboot.*$|$|\
^.*stonith-ng.* wants to fence.*$|$|\
^.*syslog-ng starting up.*$|$|\
^.*syslog-ng.*: syslog-ng shutting down; version=.*$|$|\
^.*syslog-ng.*: Termination requested via signal, terminating.*$|$|\
^.*syslogd.*restart.*$|$|\
^.*sysrq: SysRq : sysrq: Trigger a crash.*$|$|\
^.*tainting kernel.*$|$|\
^.*taints kernel.*$|$|\
^.*warning: Could not verify cluster configuration file /var/lib/pacemaker/cib/cib.xml: No such file or directory.*$|$|\
^.*warning: update_failcount:.*$|$|\
^.*Writing reset to node.*$|$|\
^.*x-info="http://www.rsyslog.com"\] exiting on signal 15..*$|$|\
^.*x-info="http://www.rsyslog.com"\] start.*$|$|\
^.*XFS.*: Log I/O Error Detected.  Shutting down filesystem.*$|$\
)"|\
# SAP
GREP_COLOR="$RED" $search "(\
^.*PreferSiteTakeover selected so decrease promotion score here.*$|$|\
^.*Promote .* to be primary.*$|$\
)" |\

# YELLOW
# $YELLOW $search '^.*.*$|$' |\
GREP_COLOR="$YELLOW" $search "(\
^.*Bad protocol version.*$|$|\
^.*blocked FC remote port time out.*$|$|\
^.*BTRFS warning.*$|$|\
^.*corosync.*Incrementing problem counter.*$|$|\
^.*Couldn.t find device with.*$|$|\
^.*Delaying fencing operations until there are resources to manage.*$|$|\
^.*device-mapper: .*error.*$|$|\
^.*Error.*$|$|\
^.*ERROR:.*$|$|\
^.*Executing reboot fencing operation .* on.*$|$|\
^.*failed.*$|$|\
^.*I_ELECTION_DC.*$|$|\
^.*I_NOT_DC.*$|$|\
^.*info: We don.t have a DC right now..*$|$|\
^.*kernel.* reservation conflict.*$|$|\
^.*mcelog:.*$|$|\
^.*notice: Removing.*from the membership list.*$|$|\
^.*Protocol major versions differ.*$|$|\
^.*Quorum lost.*$|$|\
^.*recoverable transport error.*$|$|\
^.*S_ELECTION.*$|$|\
^.*sbd_stonith can fence.*$|$|\
^.*smartd.*: .* SMART Usage Attribute.*$|$|\
^.*state is now lost.*$|$|\
^.*tur checker timed out.*$|$|\
^.*unhandled error.*$|$|\
^.*warning:.*$|$|\
^.*WARNING:.*$|$|\
^.*xfs_log_force: error.*$|$\
)" |\

# GREEN
GREP_COLOR="$GREEN" $search "(\
^.*A new membership .* was formed..*$|$|\
^.*Completed service synchronization, ready to provide service.*$|$|\
^.*corosync.*Decrementing problem counter.*$|$|\
^.*info: Node state: online.*$|$|\
^.*info: Pacemaker health check: OK.*$|$|\
^.*is now: member.*$|$|\
^.*multipathd.*reinstated.*$|$|\
^.*notice: Quorum acquired.*$|$|\
^.*quorum acquired.*$|$|\
^.*Servant starting for device.*$|$|\
^.*state is now member.*$|$|\
^.*SuSEfirewall2 not active.*$|$|\
^.*tur checker reports path is up.*$|$\
)" |\

# Supportconfig Junk
GREP_COLOR="$YELLOW" $search "^.*===========================.*$|$" |\
less
